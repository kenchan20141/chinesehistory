<!DOCTYPE html>
<html>
<head>
    <title>頭腦王者 - 最終版</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #lobby, #battle, #result { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
        .hidden { display: none; }
        .health-bar { height: 20px; background: #ddd; border-radius: 10px; margin: 10px 0; }
        .health-fill { height: 100%; background: #ff4444; border-radius: 10px; transition: width 0.3s; }
        #question { font-size: 1.2em; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        #options { display: grid; gap: 10px; margin: 20px 0; }
        .option-btn { padding: 15px; background: #e9ecef; border: none; border-radius: 5px; cursor: pointer; }
        .option-btn:hover { background: #dee2e6; }
        #waiting { text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div id="lobby">
        <h2>遊戲大廳</h2>
        <button onclick="createRoom()">創建房間</button>
        <div style="margin: 20px 0;">
            <input type="text" id="roomCode" placeholder="輸入房間代碼">
            <button onclick="joinRoom()">加入房間</button>
        </div>
    </div>

    <div id="waiting" class="hidden">
        <h3>等待對手加入...</h3>
        <p>房間代碼：<span id="displayRoomCode"></span></p>
    </div>

    <div id="battle" class="hidden">
        <div id="timer"></div>
        <div id="question"></div>
        <div id="options"></div>
        
        <div style="margin-top: 30px;">
            <div>我方血量: <span id="myHealth">100</span></div>
            <div class="health-bar"><div class="health-fill" id="myHealthBar"></div></div>
            <div>對手血量: <span id="enemyHealth">100</span></div>
            <div class="health-bar"><div class="health-fill" id="enemyHealthBar"></div></div>
        </div>
    </div>

    <div id="result" class="hidden">
        <h2 id="resultText"></h2>
        <button onclick="location.reload()">再玩一次</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBi9IEquAN1JPQTA2FVylSheVCtuAG8ZoY",
            authDomain: "game-9e2a9.firebaseapp.com",
            databaseURL: "https://game-9e2a9-default-rtdb.firebaseio.com",
            projectId: "game-9e2a9",
            storageBucket: "game-9e2a9.firebasestorage.app",
            messagingSenderId: "567367988730",
            appId: "1:567367988730:web:6ff2ee6e0cddecfaa9e043"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let roomId = null;
        let isHost = false;
        let playerId = null;

        // 創建房間
        async function createRoom() {
            try {
                isHost = true;
                playerId = 'player1';
                roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
                
                const roomRef = database.ref(`rooms/${roomId}`);
                await roomRef.set({
                    players: {
                        player1: { health: 100, answer: null },
                        player2: { health: 100, answer: null }
                    },
                    status: 'waiting',
                    currentQuestion: null
                });

                document.getElementById('displayRoomCode').textContent = roomId;
                toggleScreens('waiting');
                setupRoomListeners(roomRef);
                
                // 監聽玩家加入
                roomRef.child('players/player2').on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        toggleScreens('battle');
                        loadNewQuestion();
                    }
                });

            } catch (error) {
                alert(`創建失敗：${error.message}`);
            }
        }

        // 加入房間
        async function joinRoom() {
            try {
                roomId = document.getElementById('roomCode').value.trim().toUpperCase();
                if (!roomId) return alert('請輸入房間代碼');
                
                const roomRef = database.ref(`rooms/${roomId}`);
                const snapshot = await roomRef.once('value');
                if (!snapshot.exists()) return alert('房間不存在');

                const roomData = snapshot.val();
                if (roomData.status !== 'waiting') return alert('房間已滿');

                playerId = 'player2';
                await roomRef.update({
                    'players/player2': { health: 100, answer: null },
                    status: 'playing'
                });

                toggleScreens('battle');
                setupRoomListeners(roomRef);
                loadNewQuestion();

            } catch (error) {
                alert('加入失敗，請檢查代碼');
            }
        }

        // 設置監聽器
        function setupRoomListeners(roomRef) {
            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                updateHealthDisplay(room.players);
                
                if (room.currentQuestion && !room.currentQuestion.answered) {
                    showQuestion(room.currentQuestion);
                }

                checkGameResult(room.players);
            });
        }

        // 加載題目
        async function loadNewQuestion() {
            try {
                const questionsRef = database.ref('questions');
                const snapshot = await questionsRef.once('value');
                const questions = snapshot.val();
                const questionKeys = Object.keys(questions);
                const randomKey = questionKeys[Math.floor(Math.random() * questionKeys.length)];
                
                await database.ref(`rooms/${roomId}/currentQuestion`).set({
                    ...questions[randomKey],
                    answered: false,
                    startTime: Date.now()
                });

            } catch (error) {
                alert('題目加載失敗');
            }
        }

        // 顯示題目與選項
        function showQuestion(question) {
            document.getElementById('question').textContent = question.question;
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.onclick = () => submitAnswer(option);
                optionsContainer.appendChild(button);
            });
        }

        // 提交答案
        async function submitAnswer(answer) {
            try {
                const responseTime = Date.now() - startTime;
                await database.ref(`rooms/${roomId}/players/${playerId}`).update({
                    answer: answer,
                    time: responseTime
                });
                checkAnswers();
            } catch (error) {
                alert('提交答案失敗');
            }
        }


            checkAnswers();
        }

        // 檢查雙方答案
        async function checkAnswers() {
            const roomRef = database.ref(`rooms/${roomId}`);
            const snapshot = await roomRef.once('value');
            const room = snapshot.val();
            
            if (room.players.player1.answer && room.players.player2.answer) {
                const correctAnswer = room.currentQuestion.correctAnswer;
                const damage = calculateDamage(room.players, correctAnswer);
                
                await roomRef.update({
                    'players/player1/health': room.players.player1.health - damage.player1,
                    'players/player2/health': room.players.player2.health - damage.player2,
                    'currentQuestion/answered': true
                });

                setTimeout(loadNewQuestion, 2000);
            }
        }

        // 計算傷害值
        function calculateDamage(players, correctAnswer) {
            const damage = { player1: 0, player2: 0 };

            ['player1', 'player2'].forEach(player => {
                const isCorrect = players[player].answer === correctAnswer;
                const timeFactor = Math.max(0, (10000 - players[player].time) / 10000);
                
                if (isCorrect) {
                    const opponent = player === 'player1' ? 'player2' : 'player1';
                    damage[opponent] += Math.floor(20 * timeFactor);
                } else {
                    damage[player] += 10;
                }
            });

            return damage;
        }

        // 更新血量顯示
        function updateHealthDisplay(players) {
            const myHealth = players[playerId].health;
            const enemyId = playerId === 'player1' ? 'player2' : 'player1';
            const enemyHealth = players[enemyId].health;

            document.getElementById('myHealth').textContent = myHealth;
            document.getElementById('enemyHealth').textContent = enemyHealth;
            document.getElementById('myHealthBar').style.width = `${myHealth}%`;
            document.getElementById('enemyHealthBar').style.width = `${enemyHealth}%`;
        }

        // 遊戲結果判斷
        function checkGameResult(players) {
            if (players.player1.health <= 0 || players.player2.health <= 0) {
                const isWinner = players[playerId].health > 0;
                showResult(isWinner ? 'WIN' : 'LOSE');
            }
        }

        // 顯示結果
        function showResult(result) {
            toggleScreens('result');
            document.getElementById('resultText').textContent = result;
        }

        // 計時器
        function startTimer() {
            const timerBar = document.getElementById('timer');
            timerBar.style.width = '100%';
            setTimeout(() => timerBar.style.width = '0%', 1000);
        }

        // 切換畫面
        function toggleScreens(screen) {
            ['lobby', 'battle', 'result'].forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== screen);
            });
        }
    </script>
</body>
</html>
