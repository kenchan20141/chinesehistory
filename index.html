<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>P2P对战修复版</title>
    <style>
        /* 保持原有样式不变 */
        body { font-family: Arial; padding: 20px; }
        #roomId { width: 200px; padding: 10px; }
        .player { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .question { background: #f0f0f0; padding: 15px; margin: 10px 0; }
        .option { padding: 10px; margin: 5px; background: #e1e1e1; cursor: pointer; }
        #status { color: #666; margin: 10px 0; }
    </style>
</head>
<body>
    <div>
        <input type="text" id="roomId" placeholder="输入房间号">
        <button onclick="createRoom()">创建房间</button>
        <button onclick="joinRoom()">加入房间</button>
        <div id="status">等待连接...</div>
    </div>
    <div id="gameArea" style="display:none;">
        <div>你的HP: <span id="myHp">100</span></div>
        <div>对手HP: <span id="enemyHp">100</span></div>
        <div id="questionArea"></div>
    </div>

    <!-- 使用最新版PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        let peer;
        let conn;
        let isHost = false;
        let currentQuestion;
        let questionStartTime;

        // 配置PeerJS服务器（使用免费公共服务器）
        const peerConfig = {
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            pingInterval: 5000
        };

        // 题库保持不变
        const questions = [/* 保持原有题库 */];

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function createRoom() {
            isHost = true;
            const roomId = document.getElementById('roomId').value;
            updateStatus('正在创建房间...');
            
            peer = new Peer(roomId, peerConfig);
            
            peer.on('open', (id) => {
                updateStatus(`房间已创建，ID: ${id}`);
                document.getElementById('gameArea').style.display = 'block';
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
                updateStatus('对手已连接！');
                showNextQuestion();
            });

            peer.on('error', (err) => {
                console.error('PeerJS错误:', err);
                updateStatus(`错误: ${err.type}`);
            });
        }

        function joinRoom() {
            const roomId = document.getElementById('roomId').value;
            updateStatus('正在加入房间...');
            
            peer = new Peer(null, peerConfig); // 自动生成ID
            conn = peer.connect(roomId);

            peer.on('open', (id) => {
                updateStatus(`已连接，等待主机...`);
            });

            setupConnection();
        }

        function setupConnection() {
            conn.on('open', () => {
                updateStatus('连接成功！');
                document.getElementById('gameArea').style.display = 'block';
            });

            conn.on('data', (data) => {
                if(data.type === 'question') {
                    showQuestion(data.question);
                }
                if(data.type === 'hpUpdate') {
                    document.getElementById('enemyHp').textContent = data.enemyHp;
                    document.getElementById('myHp').textContent = data.myHp;
                }
            });

            conn.on('close', () => updateStatus('连接已断开'));
            conn.on('error', (err) => updateStatus(`连接错误: ${err.message}`));
        }

        // 保持其他函数不变（showQuestion、checkAnswer等）
        // ... 保持原有游戏逻辑函数不变 ...
    </script>
</body>
</html>
