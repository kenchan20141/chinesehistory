<!DOCTYPE html>
<html>
<head>
    <title>Brain Duel</title>
    <!-- 保持CSS樣式不變 -->
</head>
<body>
    <!-- 保持HTML結構不變 -->

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBi9IEquAN1JPQTA2FVylSheVCtuAG8ZoY",
            authDomain: "game-9e2a9.firebaseapp.com",
            projectId: "game-9e2a9",
            storageBucket: "game-9e2a9.appspot.com",
            messagingSenderId: "567367988730",
            appId: "1:567367988730:web:6ff2ee6e0cddecfaa9e043"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let gameData = { roomId: null, playerNumber: null };
        let startTime;
        // 修復題目數據缺失問題
        const questions = [
            {
                question: "What is 2+2?",
                answers: ["3", "4", "5", "6"],
                correct: 1
            },
            {
                question: "Capital of Japan?",
                answers: ["Tokyo", "Osaka", "Kyoto", "Hiroshima"],
                correct: 0
            }
        ];

        document.addEventListener('click', () => document.getElementById('bgm').play().catch(() => {}));
        
        async function initGame() {
            try {
                const roomId = prompt("Enter room ID:") || 'default-room';
                gameData.roomId = roomId;
                
                const gameRef = db.collection('games').doc(roomId);
                
                // 添加錯誤處理的監聽器
                const unsubscribe = gameRef.onSnapshot(
                    doc => {
                        if (!doc.exists) return;
                        gameData = { ...doc.data(), roomId };
                        updateUI();
                        checkGameEnd();
                    },
                    error => {
                        console.error('監聽錯誤:', error);
                        alert('即時更新失敗，請檢查網路連線');
                    }
                );

                // 強化事務處理邏輯
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(gameRef).catch(error => {
                        throw new Error(`取得文檔失敗: ${error}`);
                    });

                    if (!doc.exists) {
                        transaction.set(gameRef, {
                            players: [1],
                            healths: [100, 100],
                            currentQuestion: null,
                            answers: [],
                            questionActive: false
                        });
                        gameData.playerNumber = 1;
                    } else {
                        const existingPlayers = doc.data().players || [];
                        if (existingPlayers.length >= 2) {
                            throw new Error('房間已滿');
                        }
                        transaction.update(gameRef, {
                            players: [...existingPlayers, 2]
                        });
                        gameData.playerNumber = 2;
                    }
                }).catch(error => {
                    if (error.message.includes('房間已滿')) {
                        alert(error.message);
                        location.reload();
                    } else {
                        throw error; // 重新拋出其他錯誤
                    }
                });

                // 添加房主控制邏輯
                if (gameData.playerNumber === 1) {
                    document.addEventListener('keypress', (e) => {
                        if (e.key === 's') {
                            if (questions.length === 0) {
                                alert('尚未設置題目！');
                                return;
                            }
                            const nextQuestion = gameData.currentQuestion === null ? 0 : gameData.currentQuestion + 1;
                            if (nextQuestion >= questions.length) {
                                alert('所有題目已完成！');
                                return;
                            }
                            startNewQuestion();
                        }
                    });
                }

            } catch (error) {
                console.error('初始化錯誤:', error);
                alert(`發生錯誤: ${error.message}, 請刷新頁面`);
            }
        }

        // 添加缺失的calculateDamage函數
        function calculateDamage(answerIndex, damage) {
            if (!gameData.currentQuestion !== null && questions[gameData.currentQuestion]) {
                const correctIndex = questions[gameData.currentQuestion].correct;
                return answerIndex == correctIndex ? 
                    [gameData.healths[0], gameData.healths[1] - damage] : 
                    [gameData.healths[0] - damage, gameData.healths[1]];
            }
            return gameData.healths; // 返回原值防止錯誤
        }

        // 保持其他函數不變（startNewQuestion, handleAnswer, updateUI, checkGameEnd）
        
        // 新增遊戲結束檢查
        function checkGameEnd() {
            if (gameData.healths?.some(h => h <= 0)) {
                document.getElementById('status').textContent = 
                    gameData.healths[0] > 0 ? "Player 1 WIN!" : "Player 2 WIN!";
                setTimeout(() => location.reload(), 3000);
            }
        }

        // 初始化事件監聽
        document.getElementById('questionBox').addEventListener('click', e => {
            if (e.target.classList.contains('answer-btn')) {
                handleAnswer(parseInt(e.target.dataset.index));
            }
        });

        initGame();
    </script>
</body>
</html>
