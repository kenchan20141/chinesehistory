<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>P2P对战修复版</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        #roomId { width: 200px; padding: 10px; }
        .player { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .question { background: #f0f0f0; padding: 15px; margin: 10px 0; }
        .option { padding: 10px; margin: 5px; background: #e1e1e1; cursor: pointer; }
        #status { color: #666; margin: 10px 0; }
    </style>
</head>
<body>
    <div>
        <input type="text" id="roomId" placeholder="输入房间号">
        <button onclick="createRoom()">创建房间</button>
        <button onclick="joinRoom()">加入房间</button>
        <div id="status">等待连接...</div>
    </div>
    <div id="gameArea" style="display:none;">
        <div>你的HP: <span id="myHp">100</span></div>
        <div>对手HP: <span id="enemyHp">100</span></div>
        <div id="questionArea"></div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        let peer;
        let conn;
        let isHost = false;
        let currentQuestion;
        let questionStartTime;

        const peerConfig = {
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            pingInterval: 5000
        };

        const questions = [
            {
                question: "1 + 1等于多少？",
                options: ["1", "2", "3", "4"],
                answer: 1
            },
            {
                question: "中国的首都是哪里？",
                options: ["上海", "广州", "北京", "深圳"],
                answer: 2
            }
        ];

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function createRoom() {
            isHost = true;
            const roomId = document.getElementById('roomId').value;
            updateStatus('正在创建房间...');
            
            peer = new Peer(roomId, peerConfig);
            
            peer.on('open', (id) => {
                updateStatus(`房间已创建，ID: ${id}`);
                document.getElementById('gameArea').style.display = 'block';
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
                updateStatus('对手已连接！');
            });

            peer.on('error', (err) => updateStatus(`错误: ${err.type}`));
        }

        function joinRoom() {
            const roomId = document.getElementById('roomId').value;
            updateStatus('正在加入房间...');
            
            peer = new Peer(null, peerConfig);
            conn = peer.connect(roomId);

            peer.on('open', () => updateStatus(`已连接，等待主机...`));
            setupConnection();
        }

        function setupConnection() {
            conn.on('open', () => {
                updateStatus('连接成功！');
                document.getElementById('gameArea').style.display = 'block';
                if (isHost) showNextQuestion();
            });

            conn.on('data', (data) => {
                if(data.type === 'question') showQuestion(data.question);
                if(data.type === 'hpUpdate') updateHP(data);
            });

            conn.on('close', () => updateStatus('连接已断开'));
            conn.on('error', (err) => updateStatus(`连接错误: ${err.message}`));
        }

        function showNextQuestion() {
            currentQuestion = questions[Math.floor(Math.random() * questions.length)];
            conn.send({ type: 'question', question: currentQuestion });
            showQuestion(currentQuestion);
            questionStartTime = Date.now();
        }

        function showQuestion(q) {
            const questionArea = document.getElementById('questionArea');
            questionArea.innerHTML = `
                <div class="question">${q.question}</div>
                ${q.options.map((opt, i) => `
                    <div class="option" onclick="checkAnswer(${i})">${opt}</div>
                `).join('')}
            `;
        }

        function checkAnswer(selectedIndex) {
            const timeUsed = (Date.now() - questionStartTime) / 1000;
            let hpChange = 0;

            if (selectedIndex === currentQuestion.answer) {
                hpChange = Math.max(20 - Math.floor(timeUsed), 10);
            } else {
                hpChange = -30;
            }

            const myHp = Math.max(0, parseInt(document.getElementById('myHp').textContent) + hpChange);
            const enemyHp = parseInt(document.getElementById('enemyHp').textContent);
            
            conn.send({ 
                type: 'hpUpdate',
                myHp: enemyHp,
                enemyHp: myHp
            });

            document.getElementById('myHp').textContent = myHp;
            document.getElementById('enemyHp').textContent = enemyHp;

            if (isHost) setTimeout(showNextQuestion, 1500);
        }

        function updateHP(data) {
            document.getElementById('myHp').textContent = data.myHp;
            document.getElementById('enemyHp').textContent = data.enemyHp;
        }
    </script>
</body>
</html>
