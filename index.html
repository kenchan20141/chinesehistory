<!DOCTYPE html>
<html>
<head>
    <title>頭腦王者 - 修復版</title>
    <style>
        /* 保持原有樣式不變 */
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #lobby, #battle, #result { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
        .hidden { display: none; }
        .health-bar { height: 20px; background: #ddd; border-radius: 10px; margin: 10px 0; }
        .health-fill { height: 100%; background: #ff4444; border-radius: 10px; transition: width 0.3s; }
        #question { font-size: 1.2em; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        #timer { height: 5px; background: #4CAF50; margin: 10px 0; transition: width 1s linear; }
    </style>
</head>
<body>
    <!-- 保持原有HTML結構不變 -->
    <div id="lobby">
        <h2>遊戲大廳</h2>
        <button onclick="createRoom()">創建房間</button>
        <div style="margin: 20px 0;">
            <input type="text" id="roomCode" placeholder="輸入房間代碼">
            <button onclick="joinRoom()">加入房間</button>
        </div>
    </div>

    <div id="battle" class="hidden">
        <div id="timer"></div>
        <div id="question"></div>
        <input type="text" id="answerInput" placeholder="輸入答案" style="width: 300px; padding: 10px;">
        <button onclick="submitAnswer()">提交答案</button>
        
        <div style="margin-top: 30px;">
            <div>我方血量: <span id="myHealth">100</span></div>
            <div class="health-bar"><div class="health-fill" id="myHealthBar"></div></div>
            <div>對手血量: <span id="enemyHealth">100</span></div>
            <div class="health-bar"><div class="health-fill" id="enemyHealthBar"></div></div>
        </div>
    </div>

    <div id="result" class="hidden">
        <h2 id="resultText"></h2>
        <button onclick="location.reload()">再玩一次</button>
    </div>

    <!-- 更新Firebase SDK載入方式 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // 修正後的Firebase初始化
        const firebaseConfig = {
            apiKey: "AIzaSyBi9IEquAN1JPQTA2FVylSheVCtuAG8ZoY",
            authDomain: "game-9e2a9.firebaseapp.com",
            databaseURL: "https://game-9e2a9-default-rtdb.firebaseio.com",
            projectId: "game-9e2a9",
            storageBucket: "game-9e2a9.firebasestorage.app",
            messagingSenderId: "567367988730",
            appId: "1:567367988730:web:6ff2ee6e0cddecfaa9e043"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let roomId = null;
        let isHost = false;
        let playerId = null;
        let questionStartTime = 0;

        // 修復房間創建功能
        async function createRoom() {
            try {
                isHost = true;
                playerId = 'player1';
                roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
                
                const roomRef = database.ref(`rooms/${roomId}`);
                await roomRef.set({
                    players: {
                        player1: { health: 100, answer: null },
                        player2: { health: 100, answer: null }
                    },
                    status: 'waiting',
                    currentQuestion: null
                });

                // 新增房間存在性驗證
                const snapshot = await roomRef.once('value');
                if (!snapshot.exists()) throw new Error('房間創建失敗');

                setupRoomListeners(roomRef);
                loadNewQuestion();
                toggleScreens('battle');
                alert(`房間創建成功！房間代碼：${roomId}`);
            } catch (error) {
                console.error('創建房間錯誤:', error);
                alert('房間創建失敗，請重試');
            }
        }

        // 強化房間加入功能
        async function joinRoom() {
            try {
                roomId = document.getElementById('roomCode').value.trim().toUpperCase();
                if (!roomId) return alert('請輸入房間代碼');
                
                const roomRef = database.ref(`rooms/${roomId}`);
                const snapshot = await roomRef.once('value');
                if (!snapshot.exists()) return alert('房間不存在或已關閉');

                const roomData = snapshot.val();
                if (roomData.status !== 'waiting') return alert('房間已開始遊戲');

                isHost = false;
                playerId = 'player2';
                await roomRef.update({
                    'players/player2': { health: 100, answer: null },
                    status: 'playing'
                });

                setupRoomListeners(roomRef);
                toggleScreens('battle');
                alert('成功加入房間！');
            } catch (error) {
                console.error('加入房間錯誤:', error);
                alert('加入房間失敗，請檢查代碼');
            }
        }

        // 新增房間狀態監聽器
        function setupRoomListeners(roomRef) {
            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) {
                    alert('房間已關閉');
                    return location.reload();
                }

                updateHealthDisplay(room.players);
                
                if (room.currentQuestion && !room.currentQuestion.answered) {
                    showQuestion(room.currentQuestion);
                }

                checkGameResult(room.players);
            });

            // 新增玩家離線處理
            roomRef.child('players').on('child_removed', () => {
                alert('對手已離線');
                location.reload();
            });
        }

        // 保持其他函數不變，僅修正數據庫引用方式
        async function loadNewQuestion() {
            try {
                const questionsRef = database.ref('questions');
                const snapshot = await questionsRef.once('value');
                const questions = snapshot.val();
                const questionKeys = Object.keys(questions);
                
                if (questionKeys.length === 0) throw new Error('題庫為空');
                
                const randomKey = questionKeys[Math.floor(Math.random() * questionKeys.length)];
                const question = questions[randomKey];
                
                await database.ref(`rooms/${roomId}/currentQuestion`).set({
                    ...question,
                    answered: false,
                    startTime: Date.now()
                });
            } catch (error) {
                console.error('加載題目失敗:', error);
                alert('題目加載錯誤');
            }
        }

        // 保持其他函數不變...
        // [保持原有submitAnswer、checkAnswers、calculateDamage等函數不變]
    </script>
</body>
</html>
