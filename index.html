<div id="game">
  <div id="lobby">
    <button onclick="createRoom()">創建房間</button>
    <input type="text" id="roomId" placeholder="輸入房間ID">
    <button onclick="joinRoom()">加入房間</button>
  </div>

  <div id="battle" style="display:none;">
    <div id="question"></div>
    <input type="text" id="answer">
    <button onclick="submitAnswer()">提交答案</button>
    <div id="health">
      我方血量：<span id="myHealth">100</span> 
      敵方血量：<span id="enemyHealth">100</span>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

  const firebaseConfig = { /* 貼入你的配置 */ };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase();

  let currentRoomRef;
  let isHost = false;
  let startTime;

  function createRoom() {
    isHost = true;
    const roomId = Math.random().toString(36).substr(2, 6);
    currentRoomRef = ref(db, `rooms/${roomId}`);
    
    set(currentRoomRef, {
      players: { 
        player1: { health: 100, answer: null },
        player2: { health: 100, answer: null }
      },
      currentQuestion: null,
      status: 'waiting'
    }).then(() => {
      monitorRoom();
      document.getElementById('lobby').style.display = 'none';
      document.getElementById('battle').style.display = 'block';
    });
  }

  async function joinRoom() {
    const roomId = document.getElementById('roomId').value;
    currentRoomRef = ref(db, `rooms/${roomId}`);
    
    onValue(currentRoomRef, (snapshot) => {
      const data = snapshot.val();
      if (data.status === 'playing') {
        startGame();
      }
    });
    
    await set(ref(db, `rooms/${roomId}/players/player2`), { 
      health: 100, 
      answer: null 
    });
    
    monitorRoom();
  }
</script>

function monitorRoom() {
  onValue(currentRoomRef, (snapshot) => {
    const data = snapshot.val();
    
    // 更新血量顯示
    document.getElementById('myHealth').textContent = 
      isHost ? data.players.player1.health : data.players.player2.health;
    document.getElementById('enemyHealth').textContent = 
      isHost ? data.players.player2.health : data.players.player1.health;
    
    // 處理題目顯示
    if (data.currentQuestion && !data.currentQuestion.answered) {
      showQuestion(data.currentQuestion);
    }
    
    // 勝負判斷
    if (data.players.player1.health <= 0 || data.players.player2.health <= 0) {
      showResult(data);
    }
  });
}

function showQuestion(question) {
  document.getElementById('question').textContent = question.text;
  startTime = Date.now();
}

async function submitAnswer() {
  const answer = document.getElementById('answer').value;
  const responseTime = Date.now() - startTime;
  
  const updates = {};
  const playerPath = isHost ? 'player1' : 'player2';
  
  updates[`players/${playerPath}/answer`] = {
    answer: answer,
    time: responseTime
  };
  
  await set(currentRoomRef, updates);
  
  checkAnswers();
}

async function checkAnswers() {
  const snapshot = await get(currentRoomRef);
  const data = snapshot.val();
  
  if (data.players.player1.answer && data.players.player2.answer) {
    const correctAnswer = data.currentQuestion.correctAnswer;
    const p1 = calculateDamage(data.players.player1, correctAnswer);
    const p2 = calculateDamage(data.players.player2, correctAnswer);
    
    await set(ref(db, `rooms/${roomId}/players`), {
      player1: { health: data.players.player1.health - p1.selfDamage },
      player2: { health: data.players.player2.health - p2.selfDamage }
    });
    
    // 重置答案狀態
    await set(ref(db, `rooms/${roomId}/currentQuestion/answered`), true);
  }
}

function calculateDamage(playerAnswer, correct) {
  const isCorrect = playerAnswer.answer === correct;
  const timeFactor = Math.max(0, (10000 - playerAnswer.time) / 10000); // 10秒內答題
  
  return {
    selfDamage: isCorrect ? 0 : 10,
    enemyDamage: isCorrect ? Math.floor(20 * timeFactor) : 0
  };
}

        // 題庫服務模塊 (獨立建立question.js文件)
import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

const db = getDatabase();
const questionsRef = ref(db, 'questions');

// 題目數據結構驗證
const validateQuestion = (question) => {
  const requiredFields = ['question', 'options', 'correctAnswer', 'difficulty'];
  return requiredFields.every(field => question.hasOwnProperty(field));
};

// 隨機加載題目
export const loadRandomQuestion = async (roomId) => {
  try {
    const snapshot = await get(child(questionsRef, '/'));
    if (!snapshot.exists()) {
      throw new Error('題庫尚未初始化');
    }

    const questions = [];
    snapshot.forEach((childSnapshot) => {
      const q = childSnapshot.val();
      if (validateQuestion(q)) {
        questions.push({
          id: childSnapshot.key,
          ...q
        });
      }
    });

    if (questions.length === 0) {
      throw new Error('沒有有效題目');
    }

    const randomIndex = Math.floor(Math.random() * questions.length);
    const selectedQuestion = questions[randomIndex];

    // 更新到房間狀態
    const questionData = {
      text: selectedQuestion.question,
      options: selectedQuestion.options,
      correctAnswer: selectedQuestion.correctAnswer,
      difficulty: selectedQuestion.difficulty || 1,
      answered: false
    };

    await set(ref(db, `rooms/${roomId}/currentQuestion`), questionData);
    return questionData;

  } catch (error) {
    console.error('題目加載失敗:', error);
    throw error;
  }
};

// 題目生命周期管理
export const resetQuestionState = async (roomId) => {
  await update(ref(db, `rooms/${roomId}/currentQuestion`), {
    answered: false,
    startTime: Date.now()
  });
};
