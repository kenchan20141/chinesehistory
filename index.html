<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>中史問答對戰</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        #roomId { width: 200px; padding: 10px; }
        .player { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .question { background: #f0f0f0; padding: 15px; margin: 10px 0; }
        .option { padding: 10px; margin: 5px; background: #e1e1e1; cursor: pointer; }
        #status { color: #666; margin: 10px 0; font-size: 24px; font-weight: bold; }
        #result { display: none; font-size: 48px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body>
    <div>
        <input type="text" id="roomId" placeholder="输入房间号">
        <button onclick="createRoom()">创建房间</button>
        <button onclick="joinRoom()">加入房间</button>
        <div id="status">等待连接...</div>
    </div>
    <div id="gameArea" style="display:none;">
        <div>你的HP: <span id="myHp">100</span></div>
        <div>对手HP: <span id="enemyHp">100</span></div>
        <div id="questionArea"></div>
    </div>
    <div id="result"></div>

    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/11/14/audio_ff2b8a8e0f.mp3" type="audio/mpeg">
    </audio>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        let peer;
        let conn;
        let isHost = false;
        let currentQuestion;
        let questionStartTime;
        let gameActive = true;

        const peerConfig = {
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            pingInterval: 5000
        };

        const questions = [
            {
                question: "1 + 1等于多少？",
                options: ["1", "2", "3", "4"],
                answer: 1
            },
            {
                question: "中国的首都是哪里？",
                options: ["上海", "广州", "北京", "深圳"],
                answer: 2
            }
        ];

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function createRoom() {
            isHost = true;
            const roomId = document.getElementById('roomId').value;
            updateStatus('正在创建房间...');
            
            peer = new Peer(roomId, peerConfig);
            
            peer.on('open', (id) => {
                updateStatus(`房间已创建，ID: ${id}`);
            });

            peer.on('connection', (connection) => {
                conn = connection;
                conn.on('open', () => {
                    updateStatus('对手已连接！');
                    document.getElementById('gameArea').style.display = 'block';
                    showNextQuestion();
                });
                setupConnection();
            });

            peer.on('error', (err) => updateStatus(`错误: ${err.type}`));
        }

        function joinRoom() {
            const roomId = document.getElementById('roomId').value;
            updateStatus('正在加入房间...');
            
            peer = new Peer(null, peerConfig);
            conn = peer.connect(roomId);

            peer.on('open', () => updateStatus(`已连接，等待主机...`));

            conn.on('open', () => {
                updateStatus('连接成功！');
                document.getElementById('gameArea').style.display = 'block';
                document.getElementById('bgMusic').play().catch(() => {});
                setupConnection();
            });

            conn.on('error', (err) => updateStatus(`连接错误: ${err.message}`));
        }

        function setupConnection() {
            conn.on('data', (data) => {
                if(data.type === 'question') showQuestion(data.question);
                if(data.type === 'hpUpdate') updateHP(data);
                if(data.type === 'gameOver') handleGameOver(data);
            });

            conn.on('close', () => updateStatus('连接已断开'));
        }

        function showNextQuestion() {
            currentQuestion = questions[Math.floor(Math.random() * questions.length)];
            conn.send({ type: 'question', question: currentQuestion });
            showQuestion(currentQuestion);
            questionStartTime = Date.now();
        }

        function showQuestion(q) {
            const questionArea = document.getElementById('questionArea');
            questionArea.innerHTML = `
                <div class="question">${q.question}</div>
                ${q.options.map((opt, i) => `
                    <div class="option" onclick="checkAnswer(${i})">${opt}</div>
                `).join('')}
            `;
        }

        function checkAnswer(selectedIndex) {
            if (!gameActive) return;

            const timeUsed = (Date.now() - questionStartTime) / 1000;
            let hpChange = 0;

            if (selectedIndex === currentQuestion.answer) {
                hpChange = Math.max(20 - Math.floor(timeUsed), 10);
            } else {
                hpChange = -30;
            }

            const myHp = Math.max(0, parseInt(document.getElementById('myHp').textContent) + hpChange);
            const enemyHp = parseInt(document.getElementById('enemyHp').textContent);
            
            conn.send({ 
                type: 'hpUpdate',
                myHp: enemyHp,
                enemyHp: myHp
            });

            document.getElementById('myHp').textContent = myHp;
            document.getElementById('enemyHp').textContent = enemyHp;

            if (myHp <= 0) {
                endGame('输了！', '赢了！');
            } else if (enemyHp <= 0) {
                endGame('赢了！', '输了！');
            }

            if (isHost) setTimeout(showNextQuestion, 1500);
        }

        function updateHP(data) {
            document.getElementById('myHp').textContent = data.myHp;
            document.getElementById('enemyHp').textContent = data.enemyHp;

            if (data.myHp <= 0) {
                endGame('输了！', '赢了！');
            }
        }

        function handleGameOver(data) {
            document.getElementById('result').textContent = data.message;
            document.getElementById('result').style.display = 'block';
            document.getElementById('bgMusic').pause();
            gameActive = false;
        }

        function endGame(myResult, enemyResult) {
            gameActive = false;
            document.getElementById('result').textContent = myResult;
            document.getElementById('result').style.display = 'block';
            document.getElementById('bgMusic').pause();
            conn.send({ type: 'gameOver', message: enemyResult });
        }
    </script>
</body>
</html>
