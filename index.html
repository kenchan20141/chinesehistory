<!DOCTYPE html>
<html>
<head>
    <title>Brain Duel</title>
    <style>
        /* 原有CSS樣式保持不變 */
        body { background: #1a1a1a; color: white; font-family: Arial; text-align: center; }
        .player-container { display: flex; justify-content: space-around; margin: 20px; }
        .health-bar { width: 300px; height: 30px; background: #333; border-radius: 15px; margin: 10px; }
        .health { height: 100%; background: #00ff00; border-radius: 15px; transition: width 0.3s; }
        .question-box { background: #333; padding: 20px; margin: 20px; border-radius: 10px; }
        .answer-btn { background: #444; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .answer-btn:hover { background: #555; }
        .status { font-size: 24px; font-weight: bold; margin: 20px; }
    </style>
</head>
<body>
    <audio id="bgm" loop>
        <source src="https://assets.mixkit.co/active_storage/sfx/2593/2593-preview.mp3" type="audio/mpeg">
    </audio>
    
    <div class="player-container">
        <div>
            <div>Player 1</div>
            <div class="health-bar"><div class="health" id="health1"></div></div>
        </div>
        <div>
            <div>Player 2</div>
            <div class="health-bar"><div class="health" id="health2"></div></div>
        </div>
    </div>

    <div class="question-box" id="questionBox"></div>
    <div class="status" id="status"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // 修正後的Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyBi9IEquAN1JPQTA2FVylSheVCtuAG8ZoY",
            authDomain: "game-9e2a9.firebaseapp.com",
            projectId: "game-9e2a9", // 修正projectId
            storageBucket: "game-9e2a9.appspot.com", // 修正storageBucket格式
            messagingSenderId: "567367988730",
            appId: "1:567367988730:web:6ff2ee6e0cddecfaa9e043"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let gameData = { roomId: null, playerNumber: null };
        let startTime;
        const questions = [/* 保持原有題目不變 */];

        document.addEventListener('click', () => document.getElementById('bgm').play().catch(() => {}));
        
        async function initGame() {
            try {
                const roomId = prompt("Enter room ID:") || 'default-room';
                gameData.roomId = roomId;
                
                const gameRef = db.collection('games').doc(roomId);
                
                // 即時監聽遊戲狀態變化
                const unsubscribe = gameRef.onSnapshot(doc => {
                    if (!doc.exists) return;
                    
                    gameData = { ...doc.data(), roomId };
                    updateUI();
                    checkGameEnd();
                    
                    // 自動觸發題目顯示邏輯
                    if (gameData.currentQuestion !== null && !doc.data().questionActive) {
                        startNewQuestion();
                    }
                });

                // 使用事務處理玩家加入
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(gameRef);
                    if (!doc.exists) {
                        transaction.set(gameRef, {
                            players: [1],
                            healths: [100, 100],
                            currentQuestion: null,
                            answers: [],
                            questionActive: false
                        });
                        gameData.playerNumber = 1;
                    } else {
                        const existingPlayers = doc.data().players;
                        if (existingPlayers.length < 2) {
                            transaction.update(gameRef, {
                                players: [...existingPlayers, 2]
                            });
                            gameData.playerNumber = 2;
                        } else {
                            alert('房間已滿！');
                            location.reload();
                        }
                    }
                });

                // 開始遊戲邏輯（由房主觸發）
                if (gameData.playerNumber === 1) {
                    document.addEventListener('keypress', (e) => {
                        if (e.key === 's' && (!gameData.questionActive || gameData.currentQuestion === null)) {
                            startNewQuestion();
                        }
                    });
                }

            } catch (error) {
                console.error('初始化錯誤:', error);
                alert('發生錯誤，請刷新頁面');
            }
        }

        async function startNewQuestion() {
            try {
                const nextQuestionIndex = gameData.currentQuestion === null ? 0 : gameData.currentQuestion + 1;
                
                await db.collection('games').doc(gameData.roomId).update({
                    currentQuestion: nextQuestionIndex,
                    answers: [],
                    questionActive: true
                });
                
                startTime = Date.now();
                
                // 自動超時處理
                setTimeout(() => {
                    db.collection('games').doc(gameData.roomId).update({
                        questionActive: false
                    });
                }, 30000);
                
            } catch (error) {
                console.error('題目啟動錯誤:', error);
            }
        }

        function handleAnswer(answerIndex) {
            if (!gameData.questionActive) return;
            
            const answerTime = (Date.now() - startTime) / 1000;
            const damage = Math.max(10, 100 - Math.floor(answerTime * 10));
            
            db.collection('games').doc(gameData.roomId).update({
                answers: [...gameData.answers, answerIndex],
                healths: calculateDamage(answerIndex, damage),
                questionActive: false
            });
        }

        // 保持原有calculateDamage、updateUI、checkGameEnd函數不變
        // 新增以下錯誤處理和DOM操作改進

        function updateUI() {
            // 確保healths數組存在
            if (gameData.healths && gameData.healths.length === 2) {
                document.getElementById('health1').style.width = `${Math.max(0, gameData.healths[0])}%`;
                document.getElementById('health2').style.width = `${Math.max(0, gameData.healths[1])}%`;
            }
            
            // 優化題目顯示邏輯
            const questionBox = document.getElementById('questionBox');
            if (gameData.currentQuestion !== null && questions[gameData.currentQuestion]) {
                const q = questions[gameData.currentQuestion];
                questionBox.innerHTML = `
                    <h3>${q.question}</h3>
                    ${q.answers.map((a, i) => `
                        <button class="answer-btn" data-index="${i}">${a}</button>
                    `).join('')}
                `;
            } else {
                questionBox.innerHTML = gameData.playerNumber === 1 ? 
                    '按下 S 鍵開始遊戲' : 
                    '等待房主開始遊戲...';
            }
        }

        // 初始化事件監聽
        document.getElementById('questionBox').addEventListener('click', e => {
            if (e.target.classList.contains('answer-btn')) {
                handleAnswer(parseInt(e.target.dataset.index));
            }
        });

        initGame();
    </script>
</body>
</html>
